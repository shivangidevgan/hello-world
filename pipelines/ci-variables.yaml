# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker
parameters:
  - name : projectName
    default: ''
    type: string
  - name : imageName
    default: ''
    type: string
  - name : chartName
    default: ''
    type: string
  - name : dockerRegistryServiceConnectionName
    default: ''
    type: string
  - name: dockerfile
    default: ''
    type: string
  - name: dockerSource
    default: ''
    type: string
  - name: imageTag
    default: ''
    type: string
  - name: helmChartVersion
    default: ''
    type: string
  - name: isDotNetBased 
    default: false
    type: boolean
  # - name: isDotNet6Based 
  #   default: false
  #   type: boolean
  - name: isNodeBased 
    default: false
    type: boolean
  - name: unitTestPath 
    default: ''
    type: string
  - name: buildArguments
    default: ''
    type: string

  

variables:
  helmVersion: 3.2.3
  HELM_EXPERIMENTAL_OCI: 1
  registryServerName: '$(registryName).azurecr.io'
  isDotNetBased: ${{ parameters.isDotNetBased }}
  #isDotNet6Based: ${{ parameters.isDotNet6Based }}
  isNodeBased: ${{ parameters.isNodeBased }}
  dockerRegistryServiceConnectionName: ${{ parameters.dockerRegistryServiceConnectionName }}
  dockerfile: ${{ parameters.dockerfile }}
  dockerSource: ${{ parameters.dockerSource }}  
  projectName: ${{ parameters.projectName }}
  chartName: ${{ parameters.chartName }}   
  imageTag: ${{ parameters.imageTag }}
  helmChartVersion: ${{ parameters.helmChartVersion }}
  helmfrom: $(Build.SourcesDirectory)/devops-artifacts/charts/$(projectName)
  helmto: $(Build.ArtifactStagingDirectory)/devops-artifacts/charts/$(projectName)
  unitTestPath: ${{ parameters.unitTestPath }}
  buildArguments: ${{ parameters.buildArguments }}
  chartVersion: 0
  ${{ if ne(parameters.imageName, '') }}: 
   imageName: ${{ parameters.imageName }}
  ${{ if eq(parameters.imageName, '') }}: 
   imageName: cr.${{ parameters.projectName }}
